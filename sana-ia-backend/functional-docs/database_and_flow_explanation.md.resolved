# ExplicaciÃ³n del Schema de Base de Datos y Flujos de SANA

## ğŸ“Š Esquema de Base de Datos Actual

El schema define **9 entidades** principales organizadas en capas:

### Capa de AutenticaciÃ³n
| Entidad | PropÃ³sito |
|---------|-----------|
| **ROLES** | Define permisos (admin, user, mÃ©dico) |
| **USERS** | Usuarios registrados con disclaimer aceptado |

### Capa de Consultas
| Entidad | PropÃ³sito |
|---------|-----------|
| **CONSULTATIONS** | Cada sesiÃ³n de anÃ¡lisis del usuario |
| **SYMPTOMS** | SÃ­ntomas extraÃ­dos de la consulta (NLP) |
| **LAB_RESULTS** | Resultados de laboratorio (OCR) |

### Capa de DiagnÃ³stico
| Entidad | PropÃ³sito |
|---------|-----------|
| **DIAGNOSIS** | Resultado del anÃ¡lisis ACR (5 PorquÃ©s) |
| **RECOMMENDATIONS** | Sugerencias generadas |
| **DISEASES** | CatÃ¡logo de enfermedades con CIE-10 |
| **SPECIALISTS** | CatÃ¡logo de especialistas |

---

## ğŸ—‚ï¸ Diagrama de Relaciones

```mermaid
erDiagram
    ROLES ||--o{ USERS : "tiene"
    USERS ||--o{ CONSULTATIONS : "crea"
    USERS ||--o{ LAB_RESULTS : "sube"
    CONSULTATIONS ||--o{ SYMPTOMS : "contiene"
    CONSULTATIONS ||--o{ LAB_RESULTS : "referencia"
    CONSULTATIONS ||--|| DIAGNOSIS : "genera"
    SYMPTOMS }o--o{ DISEASES : "correlaciona"
    DIAGNOSIS ||--o{ RECOMMENDATIONS : "incluye"
    DISEASES ||--o{ SPECIALISTS : "sugiere"
```

---

## ğŸ’¬ Propuesta: Historial de Chat

Para implementar un **historial de chat** conversacional, necesitamos agregar una tabla `CHAT_MESSAGES`:

### Nueva Entidad: CHAT_MESSAGES

```mermaid
erDiagram
    CONSULTATIONS ||--o{ CHAT_MESSAGES : "contains"
    
    CHAT_MESSAGES {
        uuid id PK
        uuid consultation_id FK
        string role "user|assistant|system"
        text content
        json metadata "tokens, model, etc"
        timestamp created_at
    }
```

### Estructura propuesta:

| Campo | Tipo | DescripciÃ³n |
|-------|------|-------------|
| [id](file:///c:/Users/arm.lopez/Documents/Sana/Sana-IA-/sana-ia-backend/src/ai/ai.service.ts#73-105) | UUID | Identificador Ãºnico |
| `consultation_id` | UUID FK | Referencia a la consulta |
| `role` | ENUM | `user`, `assistant`, o `system` |
| `content` | TEXT | El mensaje en sÃ­ |
| `metadata` | JSON | Info adicional (tokens usados, modelo, etc.) |
| `created_at` | TIMESTAMP | CuÃ¡ndo se enviÃ³ |

### Ejemplo de historial guardado:

```json
[
  {
    "id": "msg-001",
    "consultation_id": "consult-123",
    "role": "user",
    "content": "Tengo dolor de cabeza intenso y visiÃ³n borrosa",
    "created_at": "2026-02-04T10:00:00Z"
  },
  {
    "id": "msg-002",
    "consultation_id": "consult-123",
    "role": "assistant",
    "content": "{...respuesta JSON del anÃ¡lisis...}",
    "metadata": { "model": "gemini-2.0-flash", "tokens": 450 },
    "created_at": "2026-02-04T10:00:02Z"
  },
  {
    "id": "msg-003",
    "consultation_id": "consult-123",
    "role": "user",
    "content": "Â¿QuÃ© laboratorios me recomiendas?",
    "created_at": "2026-02-04T10:01:00Z"
  }
]
```

---

## ğŸ‘¤ Flujo de Usuario (Frontend â†’ Backend)

```mermaid
sequenceDiagram
    actor U as Usuario
    participant F as Frontend
    participant A as Auth API
    participant AI as AI API
    participant DB as Database
    
    Note over U,DB: 1. REGISTRO Y LOGIN
    U->>F: Abre la app
    F->>A: POST /v1/auth/login
    A->>DB: Valida credenciales
    DB-->>A: Usuario encontrado
    A-->>F: { access_token, refresh_token }
    
    Note over U,DB: 2. ACEPTAR DISCLAIMER
    F->>F: Muestra disclaimer legal
    U->>F: Acepta tÃ©rminos
    F->>A: PATCH /v1/users/:id { disclaimerAccepted: true }
    
    Note over U,DB: 3. CONSULTA DE SÃNTOMAS
    U->>F: Escribe sÃ­ntomas
    F->>AI: POST /ai/analyze { symptoms, treatment, duration }
    AI->>AI: Construye prompt + System Prompt
    AI->>AI: Llama a Gemini API
    AI->>DB: Guarda consulta y diagnÃ³stico
    AI-->>F: { diagnosis, recommendations, fiveWhysTrace }
    F-->>U: Muestra resultado con disclaimer
    
    Note over U,DB: 4. (FUTURO) SUBIR LABORATORIOS
    U->>F: Sube imagen de laboratorio
    F->>AI: POST /ai/ocr { image }
    AI->>AI: Extrae biomarcadores (OCR)
    AI->>DB: Guarda LAB_RESULTS
    AI-->>F: Biomarcadores detectados
```

---

## âš™ï¸ Flujo Interno (Procesamiento del Backend)

```mermaid
flowchart TD
    subgraph INPUT["ğŸ“¥ Entrada"]
        A[Usuario envÃ­a sÃ­ntomas] --> B{Â¿Tipo de input?}
        B -->|Texto| C[SanitizaciÃ³n]
        B -->|Voz| D[Speech-to-Text]
        B -->|Imagen| E[OCR + ExtracciÃ³n]
    end
    
    subgraph PREPROCESSING["ğŸ”§ Pre-procesamiento"]
        C --> F[NLP: ExtracciÃ³n de variables crÃ­ticas]
        D --> F
        E --> G[DetecciÃ³n de Biomarcadores]
        F --> H[NormalizaciÃ³n de sÃ­ntomas]
        G --> H
    end
    
    subgraph AI_CORE["ğŸ§  Motor de IA"]
        H --> I{Â¿Es Emergencia?}
        I -->|SÃ­| J[Respuesta de emergencia inmediata]
        I -->|No| K[Construir Prompt con 5 PorquÃ©s]
        K --> L[Enviar a Gemini API]
        L --> M[Recibir respuesta JSON]
    end
    
    subgraph POSTPROCESSING["ğŸ“¤ Post-procesamiento"]
        M --> N[Validar con Zod Schema]
        N -->|VÃ¡lido| O[Guardar en DB]
        N -->|InvÃ¡lido| P[Fallback: Sugerir Medicina General]
        J --> O
        P --> O
        O --> Q[Generar PDF opcional]
        Q --> R[Retornar respuesta al usuario]
    end
```

---

## ğŸ”„ Ciclo de Vida de una Consulta

| Paso | Entidad | AcciÃ³n |
|------|---------|--------|
| 1 | `USERS` | Usuario autenticado con disclaimer aceptado |
| 2 | `CONSULTATIONS` | Se crea con `status: 'pending'` |
| 3 | `SYMPTOMS` | Se extraen del `raw_input` via NLP |
| 4 | `CONSULTATIONS` | Cambia a `status: 'processing'` |
| 5 | `DIAGNOSIS` | Se genera con el anÃ¡lisis ACR |
| 6 | `RECOMMENDATIONS` | Se crean basadas en el diagnÃ³stico |
| 7 | `CONSULTATIONS` | Cambia a `status: 'completed'` |
| 8 | `CHAT_MESSAGES` | Se guarda el intercambio (propuesto) |

---

## ğŸ“‹ Resumen de ImplementaciÃ³n Pendiente

| Funcionalidad | Estado | Prioridad |
|---------------|--------|-----------|
| AutenticaciÃ³n (Users, Roles) | âœ… Implementado | - |
| Endpoint /ai/analyze | âœ… Implementado | - |
| Persistencia de Consultations | â³ Pendiente | ğŸ”´ Alta |
| Historial de Chat (CHAT_MESSAGES) | â³ Pendiente | ğŸ”´ Alta |
| OCR para LAB_RESULTS | â³ Pendiente | ğŸ”´ Alta |
| CatÃ¡logo de DISEASES con CIE-10 | â³ Pendiente | ğŸŸ¡ Media |
| GeneraciÃ³n de PDF | â³ Pendiente | ğŸŸ¡ Media |
| Speech-to-Text | â³ Pendiente | ğŸŸ¢ Baja |
